# Scheduled Website Maintenance
#
# Runs weekly on Monday at 9:00 UTC. Uses Claude to:
# - Check for stale documentation
# - Verify all links work
# - Ensure docs are in sync with source files
# - Create a maintenance PR if updates are needed
#
# Can also be triggered by creating an issue with label "website-maintenance"
# and assigning it to @copilot (GitHub Copilot Coding Agent).
#
# Requires: ANTHROPIC_API_KEY secret + ENABLE_AI_AGENTS=true repository variable

name: Website Maintenance

on:
  schedule:
    # Every Monday at 9:00 UTC
    - cron: "0 9 * * 1"
  issues:
    types: [opened, assigned]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # â”€â”€â”€ Scheduled maintenance via Claude â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  scheduled-maintenance:
    name: Scheduled Maintenance
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      vars.ENABLE_AI_AGENTS == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run maintenance audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-sonnet-4-20250514 --max-turns 20 --dangerously-skip-permissions"
          prompt: |
            You are the Ghost Website Maintainer running a weekly maintenance audit.

            ## Tasks:
            1. **Content Sync Check**: Compare these source files with their website counterparts:
               - README.md â†” website/src/content/docs/guides/introduction.md
               - ROADMAP.md â†” website/src/content/docs/reference/roadmap.md
               - CHANGELOG.md â†” website/src/content/docs/reference/changelog.md
               - CONTRIBUTING.md â†” website/src/content/docs/reference/contributing.md

            2. **Version Check**: Read version from src-tauri/Cargo.toml and ensure website references are current.

            3. **Link Validation**: Check all internal Markdown links in website/src/content/docs/ point to existing files.

            4. **Frontmatter Quality**: Ensure every .md file in website/src/content/docs/ has proper frontmatter with title and description.

            5. **Build Verification**: Run `cd website && npm install && npm run build` to ensure the site compiles.

            ## Rules:
            - Only modify files in `website/` directory
            - Use commit message format: `docs(website): weekly maintenance â€” <summary>`
            - If nothing needs updating, report "All docs are up to date" and make no changes
            - Create separate commits for each type of fix (content sync, link fixes, formatting)

  # â”€â”€â”€ Issue-triggered Copilot agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  copilot-website-issue:
    name: Copilot Website Issue Handler
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'website-maintenance')
    steps:
      - name: Add acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              'ðŸ¤– **Website Maintenance Issue Detected**',
              '',
              'This issue has the `website-maintenance` label.',
              '',
              '**To automate this with Copilot:**',
              '1. Assign this issue to `@copilot` in the sidebar',
              '2. Copilot will use the `website-maintainer` custom agent',
              '3. A PR will be created automatically',
              '',
              '**To automate with Claude:**',
              'Comment `@claude` followed by your request.',
              '',
              '_Alternatively, this can be handled manually by the team._'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
